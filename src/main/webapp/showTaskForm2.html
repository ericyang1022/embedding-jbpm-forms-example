<html>
<head>
    <title>Test rest</title>
    <script src="js/jbpm-forms-rest-integration.js" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript">

        // Create a new instance to manage the interaction with the form
        var jbpmRestAPI = new jBPMFormsAPI();

        // This function will load the task form on the given div
        function showTaskForm(divId) {
            // Obtaining the data needed from the inputs
            var hostUrl = document.getElementById('url').value;
            var taskId = document.getElementById('taskId').value;

            // Callback that is going to execute if the task form is loaded
            var onsuccess = function (msg) {
                showHideTaskButtons('block')
            }

            // callback function that will be executed if an error occurs obtainging the form.
            // this function will receive the server response and will open an alert showing it.
            var onerror = function (msg) {
                alert("something wrong happened: " + msg);
                // cleaning the container div & reseting the object status
                jbpmRestAPI.clearContainer(divId);
            }

            jbpmRestAPI.showTaskForm(hostUrl, taskId, divId, onsuccess, onerror);
        }
        
        function getTaskLogJsonObject(actionType, divId) {
            var prjCode = $('#formdiv_form').contents().find('.gwt-Frame').contents().find('#projectcode').val();
            var processID = $('#formdiv_form').contents().find('iframe').contents().find('#processid').val();
            var processInstanceID = $('#formdiv_form').contents().find('iframe').contents().find('#processinstanceid').val();
            var taskID = document.getElementById('taskId').value;
            //var actionType = "claimTask";
            alert("prjcode=" + prjCode + ", processid=" + processID + ", processinstanceid=" + processInstanceID
            	+ ", taskID=" + taskID);
            var tasklog = {
            	"actionType" : actionType,
            	"prjCode" : prjCode, 
            	"processID" : processID, 
            	"processInstanceID" : processInstanceID, 
            	"taskID" : taskID
            };
            return tasklog;
        }
        
        function createTaskLog(divId, tasklog) {
            //alert(JSON.stringify(tasklog));
            
            $.ajax({
                type : "POST",
                url : "http://192.168.56.101:8080/springmvc/tasklog/new",
                dataType : "json",
                //contentType:"application/json", 
                data: tasklog,
                success : function(data, textStatus, jqXHR) {
                	alert("textStatus??: " + textStatus);
                	// alert("jqXHR.status: " + jqXHR.status);
                	// alert(JSON.stringify(data));
                    if (textStatus == 'success' && jqXHR.status == 200) {
                    	alert(data.result);
                    } else {
                    	alert("textStatus not 'success' and status code not 200");
                        return false;
                    }
                },
                error : function(jqXHR, textStatus, errorThrown) {
                	alert("Failed to create task log to another DB");
                	alert("jqXHR.status: " + jqXHR.status + ", textStatus: " + textStatus);
                	//alert("responseText : " + jqXHR.responseText);
                }
            });
        }

        // This function will claim the task which form is being shown on the current div
        function claimTask(divId) {
        	var tasklog = getTaskLogJsonObject("claimTask", divId);
            
        	// update task form
            var onsuccess= function(msg) {
                alert("Task claimed");
                createTaskLog(divId, tasklog); 
            };

            var onerror = function(msg) {
                alert("Error claiming task: " + msg);
                jbpmRestAPI.clearContainer(divId);
            };
            jbpmRestAPI.claimTask(divId, onsuccess, onerror);
        }

        // This function will start the task which form is being shown on the current div
        function startTask(divId) {
        	var tasklog = getTaskLogJsonObject("startTask", divId);
        	
            var onsuccess= function(msg) {
                alert("Task Started");
            	createTaskLog(divId, tasklog);
            }

            var onerror = function(msg) {
                alert("Error starting task: " + msg);
                jbpmRestAPI.clearContainer(divId);
            }
            jbpmRestAPI.startTask(divId, onsuccess, onerror)
        }

        // This function will release the task which form is being shown on the current div
        function releaseTask(divId) {
        	var tasklog = getTaskLogJsonObject("releaseTask", divId);
        	
            var onsuccess= function(msg) {
            	alert("Task released");
            	//jbpmRestAPI.clearContainer(divId);
                //showHideTaskButtons('none');
                createTaskLog(divId, tasklog);
            }

            var onerror = function(msg) {
                alert("Error releasing task: " + msg);
                jbpmRestAPI.clearContainer(divId);
            }
            jbpmRestAPI.releaseTask(divId, onsuccess, onerror)
        }

        // This function will submit the form and save the task state which form is being shown on the current div
        function saveTask(divId) {
        	var tasklog = getTaskLogJsonObject("saveTask", divId);
        	
            var onsuccess= function(msg) {
                alert("Saved Task");
                //jbpmRestAPI.clearContainer(divId);
                //showHideTaskButtons('none');
                createTaskLog(divId, tasklog);
            }

            var onerror = function(msg) {
                alert("Error saving task: " + msg);
                jbpmRestAPI.clearContainer(divId);
                showHideTaskButtons('none');
            }
            alert("showTaskForm saveTask()");
            jbpmRestAPI.saveTask(divId, onsuccess, onerror)
        }

        // This function will submit the form and complete the task which form is being shown on the current div
        function completeTask(divId) {
        	var tasklog = getTaskLogJsonObject("completeTask", divId);
        	
            var onsuccess= function(msg) {
                alert("Completed Task");
               // jbpmRestAPI.clearContainer(divId);
                // showHideTaskButtons('none');
                createTaskLog(divId, tasklog);
            }

            var onerror = function(msg) {
                alert("Error completing task: " + msg);
                jbpmRestAPI.clearContainer(divId);
                showHideTaskButtons('none');
            }
            jbpmRestAPI.completeTask(divId, onsuccess, onerror)
        }

        function showHideTaskButtons(action) {
            document.getElementById("taskbuttons").style.display = action;
        }
    </script>
</head>

<body>
<div style="padding-bottom: 15px;">
    Example of how to embedd a task form
</div>
    <table>
        <tr>
            <td>TaskId: </td>
            <td><input name="taskId" style="width:80%" id="taskId" value="1"></td>
        </tr>
        <tr>
            <td>Server URL: </td>
            <td><input name="url" style="width:80%" id="url" value="http://192.168.56.101:8080/business-central/"></td>
        </tr>
        <tr>
            <td colspan="2" align="center">
                Fill the inputs with your app data and press the "show task form" to start.
            </td>
        </tr>
        <tr>
            <td colspan="2" align="center">
                <input type="button" value="show task form" onclick="showTaskForm('formdiv')">
            </td>
        </tr>
    </table>

    <div id="formdiv" style="width: 700px; height: 300px; border: solid black 1px;">This is the div where the form will be shown!</div>
    <div id="taskbuttons" style="display: none;">
        <input type="button" value="Claim Task" onclick="claimTask('formdiv');"/>
        <input type="button" value="Start Task" onclick="startTask('formdiv');"/>
        <input type="button" value="Release Task" onclick="releaseTask('formdiv');"/>
        <input type="button" value="Save Task" onclick="saveTask('formdiv');"/>
        <input type="button" value="Complete Task" onclick="completeTask('formdiv');"/>
    </div>
</body>

</html>